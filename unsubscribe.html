import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// 全局常量 - 自定义API密钥
const VALID_API_KEY = "test-key-123"; // 与前端保持一致

Deno.serve(async (req) => {
  // 关键修复：更新CORS配置，明确允许Authorization头
  const headers = {
    "Access-Control-Allow-Origin": "https://www.rinuo.com", // 允许你的前端域名
    "Access-Control-Allow-Methods": "POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, X-API-Key, Authorization", // 新增Authorization
    "Content-Type": "application/json"
  };

  // 处理预检请求（OPTIONS）
  if (req.method === "OPTIONS") {
    return new Response(null, { headers });
  }

  try {
    // 1. 验证自定义API密钥
    const apiKey = req.headers.get("X-API-Key");
    if (!apiKey || apiKey !== VALID_API_KEY) {
      return new Response(JSON.stringify({
        success: false,
        error: "未授权访问"
      }), { status: 403, headers });
    }

    // 2. 解析请求数据
    const { token, email, reason, action } = await req.json().catch(err => {
      console.error("解析请求体失败:", err);
      return {};
    });
    
    // 3. 验证必要参数
    if (!token || !email) {
      return new Response(JSON.stringify({
        success: false,
        error: "退订参数不完整"
      }), { status: 400, headers });
    }

    // 4. 初始化Supabase客户端
    const supabaseUrl = "https://ibwhykivdlzuumcgcssl.supabase.co";
    const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
    
    if (!supabaseKey) {
      console.error("SUPABASE_SERVICE_ROLE_KEY环境变量未配置");
      return new Response(JSON.stringify({
        success: false,
        error: "服务配置错误"
      }), { status: 500, headers });
    }

    const supabase = createClient(supabaseUrl, supabaseKey);

    // 5. 如果是验证操作，仅检查记录是否存在
    if (action === "verify") {
      const { data, error } = await supabase
        .from("email_subscriptions")
        .select("id, is_subscribed")
        .eq("email", email)
        .eq("verification_token", token)
        .single();

      if (error || !data) {
        return new Response(JSON.stringify({
          success: false,
          error: "退订链接无效或已过期"
        }), { status: 403, headers });
      }

      return new Response(JSON.stringify({
        success: true,
        isSubscribed: data.is_subscribed
      }), { status: 200, headers });
    }

    // 6. 执行退订操作 - 查找匹配的订阅记录
    const { data: subscriber, error: fetchError } = await supabase
      .from("email_subscriptions")
      .select("id")
      .eq("email", email)
      .eq("verification_token", token)
      .single();

    if (fetchError) {
      console.error("订阅记录验证失败:", fetchError.message);
      return new Response(JSON.stringify({
        success: false,
        error: "退订链接无效或已过期"
      }), { status: 403, headers });
    }

    // 7. 更新订阅状态为已退订
    const { error: updateError } = await supabase
      .from("email_subscriptions")
      .update({ 
        is_subscribed: false,
        unsubscribed_at: new Date(),
        unsubscribe_reason: reason || null
      })
      .eq("id", subscriber.id);

    if (updateError) {
      throw new Error(`更新失败: ${updateError.message}`);
    }

    // 8. 返回成功响应
    return new Response(JSON.stringify({
      success: true,
      message: "已成功取消订阅"
    }), { status: 200, headers });

  } catch (error) {
    console.error("退订处理出错:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "处理退订请求时发生错误"
    }), { status: 500, headers });
  }
});
